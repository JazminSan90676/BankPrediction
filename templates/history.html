<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Historial - Banking Marketing</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
      body { font-family: "Segoe UI", Arial, sans-serif; background: #f5f6fa; }
      .container { max-width: 1400px; margin: 20px auto; }
      table td, table th { vertical-align: middle; font-size: 13px; }
      table th { background-color: #0d6efd; color: white; font-weight: bold; }
      .plot-img { max-width: 120px; height: auto; cursor: pointer; transition: transform 0.2s; }
      .plot-img:hover { transform: scale(1.2); }
      .input-value { word-break: break-word; }
      @media (max-width: 768px) {
        table { font-size: 11px; }
        .plot-img { max-width: 80px; }
      }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4">
      <div class="container">
        <a class="navbar-brand" href="/">Banking Marketing</a>
        <div class="collapse navbar-collapse">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item"><a class="nav-link" href="/">Inicio</a></li>
            <li class="nav-item"><a class="nav-link active" href="/history">Historial</a></li>
          </ul>
        </div>
      </div>
    </nav>

    <div class="container">
      <div class="card p-3">
        <h5>Historial de Predicciones</h5>
        <div class="table-responsive mt-3">
          <table class="table table-striped table-sm" id="historyTable">
            <thead>
              <tr>
                <th>ID</th>
                <th>Timestamp</th>
                <th>Edad</th>
                <th>Balance</th>
                <th>Duración (s)</th>
                <th>Campaña</th>
                <th>Trabajo</th>
                <th>Estado Civil</th>
                <th>Educación</th>
                <th>Predicción</th>
                <th>Probabilidad</th>
                <th>Accuracy</th>
                <th>Precision</th>
                <th>Recall</th>
                <th>F1</th>
                <th>Gráficas</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <script>
      async function loadHistory(){
        const res = await fetch('/history_data');
        const data = await res.json();
        const tbody = document.querySelector('#historyTable tbody');
        tbody.innerHTML = '';
        data.forEach(r => {
          const tr = document.createElement('tr');
          const inp = r.input || {};
          const age = inp.age !== undefined ? inp.age : '-';
          const balance = inp.balance !== undefined ? inp.balance : '-';
          const duration = inp.duration !== undefined ? inp.duration : '-';
          const campaign = inp.campaign !== undefined ? inp.campaign : '-';
          const job = inp.job || '-';
          const marital = inp.marital || '-';
          const education = inp.education || '-';
          const predictionLabel = r.prediction === 1 ? 'Sí' : 'No';
          tr.innerHTML = `
            <td>${r.id}</td>
            <td>${r.timestamp.substring(0, 16)}</td>
            <td class="input-value">${age}</td>
            <td class="input-value">${balance}</td>
            <td class="input-value">${duration}</td>
            <td class="input-value">${campaign}</td>
            <td class="input-value">${job}</td>
            <td class="input-value">${marital}</td>
            <td class="input-value">${education}</td>
            <td><strong>${predictionLabel}</strong></td>
            <td>${r.probability !== null ? r.probability.toFixed(3) : '-'}</td>
            <td>${r.accuracy !== null ? r.accuracy.toFixed(3) : '-'}</td>
            <td>${r.precision !== null ? r.precision.toFixed(3) : '-'}</td>
            <td>${r.recall !== null ? r.recall.toFixed(3) : '-'}</td>
            <td>${r.f1 !== null ? r.f1.toFixed(3) : '-'}</td>
            <td>
              <div class="d-flex gap-1 flex-wrap">
                <img class="plot-img" src="${r.confusion_png}" alt="Matriz de Confusión" title="Matriz de Confusión">
                <img class="plot-img" src="${r.roc_png}" alt="Curva ROC" title="Curva ROC">
                <img class="plot-img" src="${r.pr_png}" alt="Precision-Recall" title="Precision-Recall">
              </div>
            </td>
          `;
          tbody.appendChild(tr);
        });
      }
      loadHistory();
    </script>
  </body>
</html>